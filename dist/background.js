let t=null,e={timeLeft:1500,isActive:!1,isPaused:!1,currentTask:"",isBreak:!1},o=null;function l(){e.isActive&&!e.isPaused&&e.timeLeft>0&&(e.timeLeft--,i(),r(),e.timeLeft===0&&m())}function r(){try{chrome.runtime.sendMessage({type:"STATE_UPDATE",state:e}).catch(()=>{})}catch{}}function i(){const s=Math.floor(e.timeLeft/60),a=e.timeLeft%60;chrome.action.setBadgeText({text:`${s}:${a.toString().padStart(2,"0")}`}),chrome.action.setBadgeBackgroundColor({color:e.isBreak?"#22C55E":"#15243D"})}function m(){try{t&&chrome.windows.update(t.id,{focused:!0}).catch(()=>{t=null}),chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Quarter Focus",message:e.isBreak?"Break time is over. Ready to focus!":"Time for a break!",silent:!0}),chrome.runtime.sendMessage({type:"PLAY_NOTIFICATION_SOUND"}).catch(()=>{console.log("No active popup to play sound")}),e.isBreak||chrome.storage.local.get(["completedPomodoros"],s=>{const a=s.completedPomodoros||0;chrome.storage.local.set({completedPomodoros:a+1})}),e.isBreak=!e.isBreak,e.timeLeft=e.isBreak?300:1500,e.isBreak?(e.isActive=!0,e.isPaused=!1,o||(o=setInterval(l,1e3))):(e.isActive=!1,e.isPaused=!1,o&&(clearInterval(o),o=null)),i(),r()}catch(s){console.error("Timer completion failed:",s)}}chrome.runtime.onMessage.addListener((s,a,c)=>{if(s.type==="CLEAR_STORAGE")return chrome.storage.local.clear(()=>{const n=new Date().toDateString();chrome.storage.local.set({lastUpdateDate:n,completedTasks:[],completedPomodoros:0,archivedTasks:[]},()=>{c({success:!0})})}),!0;switch(s.type){case"START_TIMER":e.currentTask=s.payload.currentTask,e.isActive=!0,e.isPaused=!1,o||(o=setInterval(l,1e3)),i(),r();break;case"PAUSE_TIMER":e.isPaused=!0,i(),r();break;case"RESUME_TIMER":e.isPaused=!1,o||(o=setInterval(l,1e3)),i(),r();break;case"STOP_TIMER":o&&(clearInterval(o),o=null),e.isActive=!1,e.isPaused=!1,e.timeLeft=1500,e.currentTask="",e.isBreak=!1,chrome.action.setBadgeText({text:""}),r();break;case"GET_STATE":return c(e),!0}});chrome.action.onClicked.addListener(async()=>{if(t)try{await chrome.windows.update(t.id,{focused:!0});return}catch{t=null}const{width:s}=await chrome.windows.getLastFocused(),a=400,c=600,n=Math.round((s-a)/2);t=await chrome.windows.create({url:"index.html",type:"popup",width:a,height:c,left:n,top:100,focused:!0}),chrome.windows.onRemoved.addListener(function d(u){u===(t==null?void 0:t.id)&&(t=null,chrome.windows.onRemoved.removeListener(d))})});chrome.runtime.onStartup.addListener(()=>{t=null});
