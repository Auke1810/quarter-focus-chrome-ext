let r=null,e={timeLeft:1500,isActive:!1,isPaused:!1,currentTask:"",isBreak:!1},n=null,u=!1;async function h(){var t,s;try{console.log("Searching for existing timer window...");const i=await chrome.windows.getAll({populate:!0});if(console.log("Found windows:",i.length),r)try{const o=await chrome.windows.get(r.id);if(o)return console.log("Found active popup window:",o.id),o}catch{console.log("Active popup window no longer exists"),r=null}for(const o of i){const a=(s=(t=o.tabs)==null?void 0:t[0])==null?void 0:s.url;if(console.log("Checking window:",o.id,"URL:",a),o.type==="popup"&&a){const c=a.includes("chrome-extension://")&&a.endsWith("/index.html"),f=a.includes("quarter-focus-chrome-ext")&&a.endsWith("/index.html");if(c||f)return console.log("Found timer window:",o.id),r=o,o}}return console.log("No existing timer window found"),null}catch(i){return console.error("Error finding existing timer window:",i),null}}async function p(t){try{return console.log("Focusing window:",t),await chrome.windows.update(t,{focused:!0,drawAttention:!0}),!0}catch(s){return console.error("Error focusing window:",s),r=null,!1}}async function T(){if(console.log("Creating timer window..."),u)return console.log("Window creation already in progress"),null;try{u=!0;const t=await h();if(t)return console.log("Found existing window, focusing:",t.id),await p(t.id),t;const{width:s}=await chrome.windows.getLastFocused(),i=400,o=600,a=Math.round((s-i)/2);console.log("Creating new window...");const c=await chrome.windows.create({url:"index.html",type:"popup",width:i,height:o,left:a,top:100,focused:!0});if(!await chrome.windows.get(c.id))throw new Error("Window creation verification failed");console.log("New window created:",c.id),r=c;const m=g=>{g===(r==null?void 0:r.id)&&(console.log("Timer window closed:",g),r=null,chrome.windows.onRemoved.removeListener(m))};return chrome.windows.onRemoved.addListener(m),c}catch(t){return console.error("Error creating timer window:",t),r=null,null}finally{u=!1}}function w(){e.isActive&&!e.isPaused&&e.timeLeft>0&&(e.timeLeft--,d(),l(),e.timeLeft===0&&E())}function l(){chrome.runtime.sendMessage({type:"STATE_UPDATE",state:e}).catch(()=>{})}function d(){const t=Math.floor(e.timeLeft/60),s=e.timeLeft%60;chrome.action.setBadgeText({text:`${t}:${s.toString().padStart(2,"0")}`}),chrome.action.setBadgeBackgroundColor({color:e.isBreak?"#22C55E":"#15243D"})}async function E(){try{const t=await h();t&&await p(t.id),chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Quarter Focus",message:e.isBreak?"Break time is over. Ready to focus!":"Time for a break!",silent:!0}),chrome.runtime.sendMessage({type:"PLAY_NOTIFICATION_SOUND"}).catch(()=>{console.log("No active popup to play sound")}),e.isBreak||chrome.storage.local.get(["completedPomodoros"],s=>{const i=s.completedPomodoros||0;chrome.storage.local.set({completedPomodoros:i+1})}),e.isBreak=!e.isBreak,e.timeLeft=e.isBreak?300:1500,e.isBreak?(e.isActive=!0,e.isPaused=!1,n||(n=setInterval(w,1e3))):(e.isActive=!1,e.isPaused=!1,n&&(clearInterval(n),n=null)),d(),l()}catch(t){console.error("Timer completion failed:",t)}}chrome.runtime.onMessage.addListener((t,s,i)=>{if(t.type==="CLEAR_STORAGE")return chrome.storage.local.clear(()=>{const o=new Date().toDateString();chrome.storage.local.set({lastUpdateDate:o,completedTasks:[],completedPomodoros:0,archivedTasks:[]},()=>{i({success:!0})})}),!0;switch(t.type){case"START_TIMER":e.currentTask=t.payload.currentTask,e.isActive=!0,e.isPaused=!1,n||(n=setInterval(w,1e3)),d(),l();break;case"PAUSE_TIMER":e.isPaused=!0,d(),l();break;case"RESUME_TIMER":e.isPaused=!1,n||(n=setInterval(w,1e3)),d(),l();break;case"STOP_TIMER":n&&(clearInterval(n),n=null),e.isActive=!1,e.isPaused=!1,e.timeLeft=1500,e.currentTask="",e.isBreak=!1,chrome.action.setBadgeText({text:""}),l();break;case"GET_STATE":return i(e),!0}});chrome.action.onClicked.addListener(async()=>{await T()});chrome.runtime.onStartup.addListener(()=>{r=null,u=!1});
